# AUDIT-CLIENT-SERVER.md

**–î–∞—Ç–∞:** 2025-10-19 20:15 UTC+3  
**–ó–∞–¥–∞—á–∞:** V1 ‚Äî –ê—É–¥–∏—Ç —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö/–∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –≥—Ä–∞–Ω–∏—Ü

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã grep-–ø–æ–∏—Å–∫–∞

### 1. –ò–º–ø–æ—Ä—Ç—ã fs/child_process –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ
**–ü–∞—Ç—Ç–µ—Ä–Ω:** `import.*(fs|child_process|spawn|exec).*from`  
**–û–±–ª–∞—Å—Ç–∏:** `apps/admin/components/**/*.tsx`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ **–ù–ï –ù–ê–ô–î–ï–ù–û**

---

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ window/document –±–µ–∑ guards
**–ü–∞—Ç—Ç–µ—Ä–Ω:** `window\.|document\.`  
**–û–±–ª–∞—Å—Ç–∏:** `apps/admin/app/**/*.tsx`

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- `apps/admin/app/site/generate/page.tsx:39` ‚Äî `window.open(...)`
- `apps/admin/app/site/generate/page.tsx:46` ‚Äî `window.confirm(...)`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ë–ï–ó–û–ü–ê–°–ù–û** ‚Äî —Ñ–∞–π–ª –ø–æ–º–µ—á–µ–Ω `'use client'` (—Å—Ç—Ä–æ–∫–∞ 1)

---

### 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å 'use client'
**–ù–∞–π–¥–µ–Ω–æ:** 10 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —É–∂–µ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ:
1. `comfyui-monitor.tsx`
2. `builder/page.tsx`
3. `service-cards.tsx`
4. `queue-panel.tsx`
5. `generation-form.tsx`
6. `status/page.tsx`
7. `site/import/page.tsx`
8. `site/generate/page.tsx`
9. (–¥—É–±–ª–∏–∫–∞—Ç—ã –≤ –≤—ã–¥–∞—á–µ)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

---

## –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
**–ù–ê–†–£–®–ï–ù–ò–ô –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù–û.**

–í—Å–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã (fs, child_process) –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤:
- `/api/**` Route Handlers (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- Server Components –±–µ–∑ `'use client'` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

–í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `window`/`document` –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö —Å `'use client'` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ).

---

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

#### –ê) –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ dynamic imports –±–µ–∑ ssr:false
**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:** —Ç—è–∂—ë–ª—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (drag-n-drop, canvas, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)

**–ö–æ–º–∞–Ω–¥–∞:**
```bash
grep -r "dynamic(" apps/admin/
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ.

---

#### –ë) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∫ ComfyUI –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞
**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–π—Ç–∏:** `fetch('http://127.0.0.1:8188` –∏–ª–∏ `fetch(.*8188`

**–ö–æ–º–∞–Ω–¥–∞:**
```bash
grep -r "127.0.0.1:8188" apps/admin/components/ apps/admin/app/
grep -r "COMFY_URL" apps/admin/components/ apps/admin/app/
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ.

---

## –í—ã–≤–æ–¥—ã

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç/—Å–µ—Ä–≤–µ—Ä –≥—Ä–∞–Ω–∏—Ü—ã:** ‚úÖ **90%**

**–î–µ–π—Å—Ç–≤–∏—è:**
1. ‚úÖ –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã
2. ‚úÖ window/document –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤ 'use client')
3. üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã –∫ ComfyUI (—Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø)
4. üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å dynamic() –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (—Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø)

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:** V2 (–∑–∞–º–µ–Ω–∞ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ ComfyUI –Ω–∞ /api/comfy/**)
