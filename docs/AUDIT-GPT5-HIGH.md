<!-- Generated by GPT-5 — High-Detail Reliability Audit and Remediation Plan -->

## Executive summary

- Current state: Admin Panel live on port 3000, ComfyUI on 8188 online with 7 checkpoints, Guardian running. FLUX key configured; ALLOW_GENERATION=false (safe by default). 
- Primary incident: Image generation via ComfyUI failed with 400 prompt validation (invalid sampler_name 'euler_a'). After fixing workflow sampler, jobs transitioned to running but did not progress to completion due to background execution architecture in a request handler.
- Implemented immediately:
  - New health route `apps/admin/app/api/health/route.ts` with Comfy/FLUX/env status.
  - Hardened `apps/admin/lib/flux-client.ts` with retries/timeouts.
  - Fixed SDXL workflow sampler in `F:\Workflows\sdxl-i2i.json` (euler_a ➜ euler).
  - Improved `apps/admin/app/api/generate/route.ts`: resolves workflows via `paths.json`, validates/falls back sampler via `/object_info`, ensures output directory.
- Remaining reliability gaps:
  - Job execution model: long-running execution inside API handler background callback is not reliable for production (can be terminated). Needs a persistent worker (service) or queue processor.
  - Error schema is not unified across routes; UI lacks precise error surfacing and retry/fallback.
  - Observability is basic; no requestId correlation, limited metrics.

## Architecture overview (as-is)

- Admin Panel (Next.js 15) — `apps/admin` (Node runtime):
  - Key API routes: `/api/generate`, `/api/jobs`, `/api/comfy/*`, `/api/flux/*`, `/api/system/*`, `/api/health`, `/api/metrics`.
  - Libraries: `lib/comfy-client.ts`, `lib/flux-client.ts`, `lib/env.ts`, `lib/logger.ts`, `lib/paths.ts`, `lib/db.ts`.
- ComfyUI service (127.0.0.1:8188):
  - Endpoints: `/system_stats`, `/object_info`, `/prompt`, `/queue`, `/history/{promptId}`.
  - Workflows: `F:\Workflows\*.json` mapped via `paths.json`.
- Guardian service: monitors processes and can restart (extensible to job supervision).
- File-based state: `paths.json` and job JSON files in `C:\Work\Orchestrator\jobs`. Artifacts target `dropOut` from `paths.json`.

## Environment and configuration

- Required env (validated by `apps/admin/lib/env.ts`):
  - `BFL_API_KEY` (FLUX, required for real calls)
  - `COMFY_URL` (default `http://127.0.0.1:8188`)
  - `ALLOW_GENERATION` ('false' by default; flip to 'true' to allow real generation)
  - Optional: `HF_TOKEN`, `DATA_DIR`, `V0_API_KEY`, `NEXT_PUBLIC_APP_URL`, `LOG_LEVEL`, `NODE_ENV`
- Paths (`paths.json`):
  - `workflows`: `F:\Workflows`
  - `dropOut`: `F:\Drop\out`
  - `jobs`: `C:\Work\Orchestrator\jobs`

## Findings and root causes

1) ComfyUI prompt validation failure (fixed):
   - Error: 400 prompt_outputs_failed_validation → `KSampler.sampler_name 'euler_a' not in list`.
   - Root cause: Incompatible sampler value in workflow JSON versus current ComfyUI build’s allowed sampler list (from `/object_info`).
   - Fixes:
     - Rewrote workflow to valid sampler `euler` in `F:\Workflows\sdxl-i2i.json`.
     - At runtime, added sampler validation and fallback using `/object_info` in `generate/route.ts`.

2) Job execution lifecycle unreliable (pending):
   - Symptom: Jobs set to `running` then stall (no `/prompt` ID logged; `/queue` empty). Likely background task in route handler not guaranteed to continue after response.
   - Root cause: Executing long-running work inside an API route via fire-and-forget promise, which can be suspended/terminated in production.
   - Recommendation: Introduce a persistent job-runner worker (Windows service) that polls the `jobs` table/folder and executes jobs reliably with retries and progress updates. Optionally, reuse/extend Guardian or create `orchestrator-worker` (Node) as NSSM service.

3) Error schema and UX (pending):
   - Inconsistent error bodies across routes; difficult for UI to display actionable messages and retry.
   - Recommendation: Define a typed error schema (code, message, details, hint) and use a small helper in all routes. Map provider errors (FLUX moderation, Comfy validation) cleanly.

4) Observability (pending):
   - No requestId propagation, limited metrics beyond `/api/metrics`. Lacking per-job metrics and correlation.
   - Recommendation: Add requestId/jobId to logs; expose Prometheus metrics for job lifecycle (created/running/done/failed, duration p50/p95/p99) and provider calls.

5) Guardian integration (pending):
   - Guardian currently monitors services but doesn’t resolve stuck jobs or crashed job-runner.
   - Recommendation: Add playbooks: detect stale running jobs (no progress N minutes), restart worker, mark job failed with actionable error, alert.

6) Security hygiene (pending):
   - Ensure CORS/CSRF/rate-limit on public routes; validate proxy paths to Comfy (avoid SSRF).

## Changes implemented in this pass

- `apps/admin/app/api/health/route.ts`: new health endpoint aggregating Comfy status, models count, env flags.
- `apps/admin/lib/flux-client.ts`: added `fetchWithRetry` with exponential backoff and timeouts for `generateFlux` and `pollFlux`.
- `apps/admin/app/api/generate/route.ts`:
  - Workflows path resolved via `paths.json` (`resolvePath('workflows')`).
  - Sampler validation using `/object_info` with fallback to a valid sampler, normalization (euler_a ➜ euler).
  - Ensures `dropOut` directory exists before saving artifacts.
- `F:\Workflows\sdxl-i2i.json`: `KSampler.inputs.sampler_name: euler_a` → `euler`.

## Remediation plan (phased)

Phase A — Reliability (Jobs & Comfy)
1. Implement persistent job-runner worker:
   - Create `services/worker` (Node) reading from DB or `jobs` dir; loop: pick `queued`/`created` ➜ `running` ➜ execute ➜ `done/failed`.
   - Move current `executeFlux/executeComfyUI` into a shared module (e.g., `packages/connectors` or `apps/admin/lib/executor.ts`).
   - Add idempotency key: avoid duplicate execution on restarts.
   - Persist progress and logs; provide `/api/jobs/run` only for manual/debug.
2. Comfy execution hardening:
   - Validate workflow nodes (existence of KSampler, EmptyLatentImage, positive/negative text nodes) before submit; fail fast with clear error.
   - Poll `/history/{promptId}` until completion; optional SSE for progress.
   - Robust output file resolution (decode from `history.outputs` reliably for different workflows). Save relative paths into job.result.

Phase B — API and UX
3. Unified error schema:
   - Add `lib/api-error.ts` with `error(code, message, details?, hint?)` → `NextResponse` helper.
   - Refactor `/api/generate`, `/api/flux/*`, `/api/comfy/*` to use it.
4. UI improvements:
   - `components/generation-form.tsx`: preflight checks (ALLOW_GENERATION, Comfy online, models count); clear error banners and retry.
   - `components/queue-panel.tsx`: implement run/cancel/view with polling; show progress and logs.

Phase C — Observability
5. Metrics and logging:
   - Add requestId/jobId correlation; log levels and JSON logs in prod.
   - Prometheus metrics: job lifecycle counters, durations, external API latency, error rates.
   - Sentry: tag with `service`, `route`, `jobId`; capture request errors (Next 15 `onRequestError`).

Phase D — Guardian & Ops
6. Guardian extensions:
   - Monitor worker health (heartbeat); restart on failure; limit restart frequency (backoff).
   - Detect stale jobs; apply playbook (interrupt Comfy if needed, mark failed).
7. Deployment & NSSM:
   - Ensure Admin Panel/Worker/Comfy services installed with env; log rotation; Recovery options enabled.

Phase E — Security & Tests
8. Security:
   - Rate-limit public routes; CORS policy; input validation; avoid proxying arbitrary paths.
9. Tests:
   - Playwright e2e: generation Comfy SDXL and FLUX to final artifact.
   - Contract tests for `/api/generate`, `/api/jobs`, `/api/health`.

## Handover checklist (for another engineer)

- Read `docs/PRODUCTION-AUDIT-REPORT.md` and this file.
- Verify env: `ALLOW_GENERATION`, `BFL_API_KEY`, `COMFY_URL`.
- Verify `paths.json` paths exist and are writable (`data`, `jobs`, `dropOut`, `workflows`).
- Run health checks:
  - `GET /api/health`
  - `GET /api/comfy/status`, `GET /api/selfcheck`
- Try a dry-run FLUX: `POST /api/flux/generate` with `{ confirmed:false }`.
- Create Comfy job via UI, observe `/api/jobs` and logs.
- If jobs stall at `running`, run worker manually (until service is implemented) and confirm completion.

## Runbook snippets

- Restart ComfyUI service (NSSM): `nssm restart OrchestratorComfyUI`
- Check Comfy models: `GET http://127.0.0.1:8188/object_info`
- Submit simple generation (sdxl): `POST /api/generate { backend:'sdxl', prompt:'...' , runNow:true }`
- Inspect failing job: `GET /api/jobs?id=<jobId>`; check `logs` and `result.error`.

## Acceptance criteria

- Generations (Comfy SDXL/SD3.5/SVD, FLUX) succeed end-to-end with artifacts saved to `dropOut`.
- Failures produce unified error responses with actionable hints.
- Worker restarts do not lose jobs; idempotent execution.
- Metrics expose job counts/durations; Sentry captures request and execution errors.

## Risks and mitigations

- Long-running work inside routes can be terminated ➜ move to persistent worker.
- Model config drift (workflows) ➜ runtime validation and central templates; CI lint check for workflow keys.
- External API instability ➜ retries/backoff, circuit breaker for FLUX.

## References (files)

- `apps/admin/app/api/health/route.ts`
- `apps/admin/app/api/generate/route.ts`
- `apps/admin/lib/flux-client.ts`
- `apps/admin/lib/comfy-client.ts`
- `apps/admin/lib/env.ts`
- `apps/admin/lib/paths.ts`
- `paths.json`
- `F:\Workflows\sdxl-i2i.json`


